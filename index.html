<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‡ºè²¨ç´€éŒ„ (æ¥µç°¡ç‰ˆ)</title>
    <style>
        /* åŸºç¤è¨­å®š */
        body { 
            font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif; 
            background: #FFFFFF; 
            color: #333; 
            margin: 0; 
            padding: 5px; /* æ¥µå°é‚Šè· */
            height: 100vh;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        /* 1. æ§åˆ¶å€å¡Šï¼šæ”¹ç”¨ Grid ä½ˆå±€ï¼Œæ¥µçœç©ºé–“ */
        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* å·¦å³å…©æ¬„ */
            gap: 5px; /* é–“è·æ¥µå° */
            margin-bottom: 5px;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        /* è¼¸å…¥æ¡†æ¨£å¼å„ªåŒ– */
        select, input {
            width: 100%;
            padding: 8px 5px; /* ç¸®å°å…§è· */
            font-size: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: #fff;
            color: #333;
            box-sizing: border-box;
            height: 40px; /* å›ºå®šé«˜åº¦ï¼Œæ•´é½Š */
        }
        
        /* æ¨™é¡Œå°å­— (ç¨å¾®æç¤ºç”¨) */
        .grid-item span {
            display: block;
            font-size: 11px;
            color: #666;
            margin-bottom: 2px;
            font-weight: bold;
        }

        /* 2. ç›¸æ©Ÿå€å¡Šï¼šè‡ªå‹•å¡«æ»¿å‰©é¤˜ç©ºé–“ */
        #camera-wrapper {
            flex-grow: 1; /* åƒæ‰å‰©é¤˜é«˜åº¦ */
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            background: #000;
            overflow: hidden;
            border-radius: 4px;
            border: 1px solid #333;
            display: flex;
            align-items: center; /* å‚ç›´ç½®ä¸­ */
            justify-content: center;
        }
        
        video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* è®“ç•«é¢å¡«æ»¿ä¸ç•™é»‘é‚Š */
        }

        /* 3. æŒ‰éˆ•å€ */
        #snap-btn {
            width: 100%;
            max-width: 600px;
            padding: 12px;
            font-size: 16px;
            margin: 8px auto 0 auto; /* ä¸Šæ–¹ç•™ä¸€é»é»ç©ºéš™ */
            cursor: pointer;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
        }

        /* çµæœå€ (æµ®å‹•å±¤æˆ–è¦†è“‹å±¤ï¼Œé¿å…æ¨æ“ ç‰ˆé¢) */
        #result-area {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.98);
            z-index: 999;
            overflow-y: auto;
            padding: 20px;
            text-align: center;
        }

        #result-image {
            width: 100%;
            max-width: 500px;
            border: 1px solid #999;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        #reset-btn {
            padding: 10px 30px;
            font-size: 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,123,255,0.3);
            margin-bottom: 15px;
        }

        .ios-alert {
            background: #ffc107;
            color: #000;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

    <!-- 1. æ¥µç°¡æ§åˆ¶å€ (2x2 æ’åˆ—) -->
    <div class="controls-grid">
        <!-- å·¦ä¸Šï¼šåœ°é» -->
        <div class="grid-item">
            <span>ğŸ“ é–€å¸‚/DC</span>
            <select id="location-select">
                <option value="é‚£ç‘ªå¤é–€å¸‚">é‚£ç‘ªå¤é–€å¸‚</option>
                <option value="éœ§å°é–€å¸‚">éœ§å°é–€å¸‚</option>
                <option value="æ¡ƒæºé–€å¸‚">æ¡ƒæºé–€å¸‚</option>
                <option value="æ–°å¸‚">æ–°å¸‚</option>
                <option value="æ–°å¸‚ç‰©æµåœ’å€">æ–°å¸‚ç‰©æµåœ’å€</option>
                <option value="å˜‰ç¾©">å˜‰ç¾©</option>
                <option value="å°ä¸­">å°ä¸­</option>
                <option value="å¤§è‚š">å¤§è‚š</option>
                <option value="æ¹–å£">æ¹–å£</option>
                <option value="é›»ç ”">é›»ç ”</option>
                <option value="æš–æš–">æš–æš–</option>
                <option value="èŠ±è“®">èŠ±è“®</option>
            </select>
        </div>

        <!-- å³ä¸Šï¼šé …ç›® -->
        <div class="grid-item">
            <span>ğŸ“¦ é …ç›®</span>
            <select id="action-select">
                <option value="å‡ºè²¨ç´€éŒ„">å‡ºè²¨ç´€éŒ„</option>
                <option value="åº«å­˜èª¿æ’¥">åº«å­˜èª¿æ’¥</option>
                <option value="ç•°å¸¸å›å ±">ç•°å¸¸å›å ±</option>
                <option value="å…¶ä»–å‚™è¨»">å…¶ä»–å‚™è¨»</option>
            </select>
        </div>

        <!-- å·¦ä¸‹ï¼šå”åŠ©äººå“¡ -->
        <div class="grid-item">
            <span>ğŸ™‹â€â™‚ï¸ å”åŠ©äººå“¡</span>
            <select id="person-select">
                <option value="">ç„¡ (ä¸é¡¯ç¤º)</option>
                <option value="æ—©ç­ESäººå“¡">æ—©ç­ESäººå“¡</option>
                <option value="æ™šç­ESäººå“¡">æ™šç­ESäººå“¡</option>
            </select>
        </div>

        <!-- å³ä¸‹ï¼šæ•¸é‡å‚™è¨» (æ–°å¢) -->
        <div class="grid-item">
            <span>ğŸ“ å‚™è¨»/æ•¸é‡</span>
            <input type="text" id="qty-input" placeholder="ä¾‹: 2ç‰ˆ5ç®±">
        </div>
    </div>

    <!-- 2. ç›¸æ©Ÿå€ (Flex Grow) -->
    <div id="camera-wrapper">
        <video id="video" autoplay playsinline></video>
    </div>

    <!-- 3. æ‹ç…§æŒ‰éˆ• -->
    <button id="snap-btn">ğŸ“¸ æ‹ç…§å­˜æª”</button>

    <!-- éš±è—ç•«å¸ƒ -->
    <canvas id="canvas" style="display:none;"></canvas>

    <!-- 4. çµæœé¡¯ç¤ºå€ (å…¨è¢å¹•è¦†è“‹) -->
    <div id="result-area">
        <div style="max-width: 600px; margin: 0 auto;">
            <div class="ios-alert">âš ï¸ iPhone è«‹ã€Œé•·æŒ‰åœ–ç‰‡ã€åŠ å…¥ç…§ç‰‡</div>
            <br>
            <img id="result-image" src="" alt="Generated Photo">
            <br>
            <button id="reset-btn">ğŸ”„ ç¹¼çºŒæ‹ä¸‹ä¸€å¼µ</button>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const resultArea = document.getElementById('result-area');
        const resultImage = document.getElementById('result-image');
        const snapBtn = document.getElementById('snap-btn');
        const resetBtn = document.getElementById('reset-btn');
        
        const locationSelect = document.getElementById('location-select');
        const actionSelect = document.getElementById('action-select');
        const personSelect = document.getElementById('person-select');
        const qtyInput = document.getElementById('qty-input'); // æ–°å¢

        // 1. å•Ÿå‹•ç›¸æ©Ÿ
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
            .then(stream => {
                video.srcObject = stream;
            })
            .catch(err => {
                alert("ç›¸æ©Ÿé–‹å•Ÿå¤±æ•—: " + err);
            });

        // 2. æ‹ç…§é‚è¼¯
        snapBtn.addEventListener('click', () => {
            const context = canvas.getContext('2d');
            
            const w = video.videoWidth;
            const h = video.videoHeight;
            // ç™½åº•é«˜åº¦å¾®èª¿è‡³ 15% (ç‚ºäº†å®¹ç´å¯èƒ½çš„ç¬¬ä¸‰è¡Œå‚™è¨»)
            const footerHeight = h * 0.15; 
            
            canvas.width = w;
            canvas.height = h + footerHeight;

            // ç•«ç™½åº•
            context.fillStyle = "#FFFFFF";
            context.fillRect(0, 0, canvas.width, canvas.height);

            // ç•«ç…§ç‰‡
            context.drawImage(video, 0, 0, w, h);

            // æº–å‚™è³‡æ–™
            const loc = locationSelect.value;
            const act = actionSelect.value;
            const person = personSelect.value; 
            const qty = qtyInput.value.trim(); // å–å¾—æ•¸é‡å‚™è¨»
            const dateText = new Date().toLocaleDateString('zh-TW');

            // å­—é«”å¤§å° (å‹•æ…‹è¨ˆç®—)
            const fontSizeMain = Math.floor(w * 0.035); 
            const fontSizeSub = Math.floor(w * 0.028); 

            // ç‰ˆé¢é…ç½®åƒæ•¸
            const padX = w * 0.03; 
            // ç¬¬ä¸€è¡Œæ–‡å­—åŸºæº–ç·š
            const line1Y = h + (footerHeight * 0.35);
            // ç¬¬äºŒè¡Œæ–‡å­—åŸºæº–ç·š
            const line2Y = h + (footerHeight * 0.65);
            // ç¬¬ä¸‰è¡Œæ–‡å­—åŸºæº–ç·š (å‚™è¨»ç”¨)
            const line3Y = h + (footerHeight * 0.90);

            context.textAlign = "left";
            context.fillStyle = "#000000"; // é»‘è‰²ä¸»å­—

            // --- å·¦å´è³‡è¨Š ---
            // 1. é–€å¸‚
            context.font = `bold ${fontSizeMain}px 'å¾®è»Ÿæ­£é»‘é«”', Arial`;
            context.fillText(`é–€å¸‚/DCï¼š${loc}`, padX, line1Y);
            
            // 2. é …ç›®
            context.font = `${fontSizeSub}px 'å¾®è»Ÿæ­£é»‘é«”', Arial`;
            context.fillText(`é …ç›®ï¼š${act}`, padX, line2Y);

            // --- å³å´è³‡è¨Š ---
            context.textAlign = "right";
            const rightX = w - padX;

            // 1. å”åŠ©äººå“¡ (è—å­—)
            if (person !== "") {
                context.font = `bold ${fontSizeSub}px 'å¾®è»Ÿæ­£é»‘é«”', Arial`;
                context.fillStyle = "#0056b3"; 
                context.fillText(`éº»ç…© ${person} å”åŠ©ï¼Œæ„Ÿè¬`, rightX, line1Y);
            } else {
                // å¦‚æœæ²’æœ‰äººï¼Œæ—¥æœŸå¾€ä¸Šç§»ä¸€é»ï¼Œæˆ–æ˜¯ä¿æŒåœ¨ç¬¬äºŒè¡Œçš†å¯ã€‚
                // é€™è£¡æˆ‘å€‘ç¶­æŒæ—¥æœŸåœ¨ç¬¬äºŒè¡Œï¼Œä¿æŒç‰ˆé¢æ•´é½Šã€‚
            }

            // 2. æ—¥æœŸ (ç°å­—)
            context.fillStyle = "#555";
            context.font = `${fontSizeSub}px 'å¾®è»Ÿæ­£é»‘é«”', Arial`;
            context.fillText(`æ—¥æœŸï¼š${dateText}`, rightX, line2Y);

            // --- æ–°å¢ï¼šåº•éƒ¨å‚™è¨» (å¦‚æœæœ‰è¼¸å…¥æ‰é¡¯ç¤º) ---
            if (qty !== "") {
                context.textAlign = "left"; // é å·¦é¡¯ç¤º
                context.fillStyle = "#D32F2F"; // ç”¨ç´…è‰²å¼·èª¿
                context.font = `bold ${fontSizeSub}px 'å¾®è»Ÿæ­£é»‘é«”', Arial`;
                // é¡¯ç¤ºåœ¨æœ€ä¸‹æ–¹
                context.fillText(`å‚™è¨»/æ•¸é‡ï¼š${qty}`, padX, line3Y);
            }

            // åˆ†éš”ç·š
            context.strokeStyle = "#ddd";
            context.lineWidth = 1;
            context.beginPath();
            context.moveTo(0, h);
            context.lineTo(w, h);
            context.stroke();

            // è¼¸å‡º
            const dataURL = canvas.toDataURL('image/jpeg', 0.95);
            resultImage.src = dataURL;
            
            // é¡¯ç¤ºå…¨è¢å¹•çµæœå±¤
            resultArea.style.display = 'block';

            // Android è‡ªå‹•ä¸‹è¼‰
            let filename = `${loc}_${act}`;
            if(qty !== "") filename += `_${qty}`; // æª”åä¹ŸåŠ å…¥å‚™è¨»
            filename += `_${dateText.replace(/\//g, '')}.jpg`;

            autoDownload(dataURL, filename);
        });

        // 3. ç¹¼çºŒæ‹ä¸‹ä¸€å¼µ
        resetBtn.addEventListener('click', () => {
            resultArea.style.display = 'none';
            resultImage.src = "";
            // æ¸…ç©ºå‚™è¨»æ¬„ä½ (çœ‹éœ€æ±‚ï¼Œé€šå¸¸æ‹ä¸‹ä¸€å¼µå¯èƒ½æ•¸é‡ä¸åŒï¼Œæ¸…ç©ºæ¯”è¼ƒå¥½)
            // qtyInput.value = ""; 
        });

        function autoDownload(url, filename) {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            if (isIOS) return; 

            const link = document.createElement('a');
            link.download = filename;
            link.href = url;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
